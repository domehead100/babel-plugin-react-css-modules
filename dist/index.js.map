{"version":3,"sources":["../src/index.js"],"names":["ajv","$data","validate","compile","t","types","filenameMap","setupFileForRuntimeResolution","path","filename","programPath","findParent","parentPath","isProgram","importedHelperIndentifier","scope","generateUidIdentifier","styleModuleImportMapIdentifier","unshiftContainer","importDeclaration","importDefaultSpecifier","stringLiteral","firstNonImportDeclarationNode","get","find","node","isImportDeclaration","insertBefore","variableDeclaration","variableDeclarator","styleModuleImportMap","addWebpackHotModuleAccept","test","memberExpression","identifier","consequent","blockStatement","expressionStatement","callExpression","source","value","functionExpression","hotAcceptStatement","ifStatement","pushContainer","getTargetResourcePath","stats","targetFileDirectoryPath","file","opts","startsWith","require","resolve","notForPlugin","filetypes","extension","lastIndexOf","substr","Object","keys","indexOf","exclude","match","RegExp","inherits","visitor","ImportDeclaration","targetResourcePath","styleImportName","specifiers","length","local","name","console","warn","Error","context","generateScopedName","webpackHotModuleReloading","removeImport","remove","JSXElement","styleNameAttribute","openingElement","attributes","attribute","handleMissingStyleName","isStringLiteral","isJSXExpressionContainer","Program","error","errors"],"mappings":"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","file":"index.js","sourcesContent":["// @flow\r\n\r\nimport {\r\n  dirname,\r\n  resolve\r\n} from 'path';\r\nimport babelPluginJsxSyntax from 'babel-plugin-syntax-jsx';\r\nimport BabelTypes from 'babel-types';\r\nimport ajvKeywords from 'ajv-keywords';\r\nimport Ajv from 'ajv';\r\nimport optionsSchema from './schemas/optionsSchema.json';\r\nimport optionsDefaults from './schemas/optionsDefaults';\r\nimport createObjectExpression from './createObjectExpression';\r\nimport requireCssModule from './requireCssModule';\r\nimport resolveStringLiteral from './resolveStringLiteral';\r\nimport replaceJsxExpressionContainer from './replaceJsxExpressionContainer';\r\n\r\nconst ajv = new Ajv({\r\n  // eslint-disable-next-line id-match\r\n  $data: true\r\n});\r\n\r\najvKeywords(ajv);\r\n\r\nconst validate = ajv.compile(optionsSchema);\r\n\r\nexport default ({\r\n  types: t\r\n}: {\r\n  types: BabelTypes\r\n}) => {\r\n  const filenameMap = {};\r\n\r\n  const setupFileForRuntimeResolution = (path, filename) => {\r\n    const programPath = path.findParent((parentPath) => {\r\n      return parentPath.isProgram();\r\n    });\r\n\r\n    filenameMap[filename].importedHelperIndentifier = programPath.scope.generateUidIdentifier('getClassName');\r\n    filenameMap[filename].styleModuleImportMapIdentifier = programPath.scope.generateUidIdentifier('styleModuleImportMap');\r\n\r\n    programPath.unshiftContainer(\r\n      'body',\r\n      t.importDeclaration(\r\n        [\r\n          t.importDefaultSpecifier(\r\n            filenameMap[filename].importedHelperIndentifier\r\n          )\r\n        ],\r\n        t.stringLiteral('babel-plugin-react-css-modules/dist/browser/getClassName')\r\n      )\r\n    );\r\n\r\n    const firstNonImportDeclarationNode = programPath.get('body').find((node) => {\r\n      return !t.isImportDeclaration(node);\r\n    });\r\n\r\n    firstNonImportDeclarationNode.insertBefore(\r\n      t.variableDeclaration(\r\n        'const',\r\n        [\r\n          t.variableDeclarator(\r\n            filenameMap[filename].styleModuleImportMapIdentifier,\r\n            createObjectExpression(t, filenameMap[filename].styleModuleImportMap)\r\n          )\r\n        ]\r\n      )\r\n    );\r\n    // eslint-disable-next-line\r\n    // console.log('setting up', filename, util.inspect(filenameMap,{depth: 5}))\r\n  };\r\n\r\n  const addWebpackHotModuleAccept = (path) => {\r\n    const test = t.memberExpression(t.identifier('module'), t.identifier('hot'));\r\n    const consequent = t.blockStatement([\r\n      t.expressionStatement(\r\n        t.callExpression(\r\n          t.memberExpression(\r\n            t.memberExpression(t.identifier('module'), t.identifier('hot')),\r\n            t.identifier('accept')\r\n          ),\r\n          [\r\n            t.stringLiteral(path.node.source.value),\r\n            t.functionExpression(null, [], t.blockStatement([\r\n              t.expressionStatement(\r\n                t.callExpression(\r\n                  t.identifier('require'),\r\n                  [t.stringLiteral(path.node.source.value)]\r\n                )\r\n              )\r\n            ]))\r\n          ]\r\n        )\r\n      )\r\n    ]);\r\n\r\n    const programPath = path.findParent((parentPath) => {\r\n      return parentPath.isProgram();\r\n    });\r\n\r\n    const firstNonImportDeclarationNode = programPath.get('body').find((node) => {\r\n      return !t.isImportDeclaration(node);\r\n    });\r\n\r\n    const hotAcceptStatement = t.ifStatement(test, consequent);\r\n\r\n    if (firstNonImportDeclarationNode) {\r\n      firstNonImportDeclarationNode.insertBefore(hotAcceptStatement);\r\n    } else {\r\n      programPath.pushContainer('body', hotAcceptStatement);\r\n    }\r\n  };\r\n\r\n  const getTargetResourcePath = (path: *, stats: *) => {\r\n    const targetFileDirectoryPath = dirname(stats.file.opts.filename);\r\n\r\n    if (path.node.source.value.startsWith('.')) {\r\n      return resolve(targetFileDirectoryPath, path.node.source.value);\r\n    }\r\n\r\n    return require.resolve(path.node.source.value);\r\n  };\r\n\r\n  const notForPlugin = (path: *, stats: *) => {\r\n    stats.opts.filetypes = stats.opts.filetypes || {};\r\n\r\n    const extension = path.node.source.value.lastIndexOf('.') > -1 ? path.node.source.value.substr(path.node.source.value.lastIndexOf('.')) : null;\r\n\r\n    if (extension !== '.css' && Object.keys(stats.opts.filetypes).indexOf(extension) < 0) {\r\n      return true;\r\n    }\r\n\r\n    if (stats.opts.exclude && getTargetResourcePath(path, stats).match(new RegExp(stats.opts.exclude))) {\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  };\r\n\r\n  return {\r\n    inherits: babelPluginJsxSyntax,\r\n    visitor: {\r\n      ImportDeclaration (path: *, stats: *): void {\r\n        if (notForPlugin(path, stats)) {\r\n          return;\r\n        }\r\n\r\n        const filename = stats.file.opts.filename;\r\n        const targetResourcePath = getTargetResourcePath(path, stats);\r\n\r\n        let styleImportName: string;\r\n\r\n        if (path.node.specifiers.length === 0) {\r\n          // use imported file path as import name\r\n          styleImportName = path.node.source.value;\r\n        } else if (path.node.specifiers.length === 1) {\r\n          styleImportName = path.node.specifiers[0].local.name;\r\n        } else {\r\n          // eslint-disable-next-line no-console\r\n          console.warn('Please report your use case. https://github.com/gajus/babel-plugin-react-css-modules/issues/new?title=Unexpected+use+case.');\r\n\r\n          throw new Error('Unexpected use case.');\r\n        }\r\n\r\n        filenameMap[filename].styleModuleImportMap[styleImportName] = requireCssModule(targetResourcePath, {\r\n          context: stats.opts.context,\r\n          filetypes: stats.opts.filetypes || {},\r\n          generateScopedName: stats.opts.generateScopedName\r\n        });\r\n\r\n        if (stats.opts.webpackHotModuleReloading) {\r\n          addWebpackHotModuleAccept(path);\r\n        }\r\n\r\n        if (stats.opts.removeImport) {\r\n          path.remove();\r\n        }\r\n      },\r\n      JSXElement (path: *, stats: *): void {\r\n        const filename = stats.file.opts.filename;\r\n        const styleNameAttribute = path.node.openingElement.attributes\r\n          .find((attribute) => {\r\n            return typeof attribute.name !== 'undefined' && attribute.name.name === 'styleName';\r\n          });\r\n\r\n        if (!styleNameAttribute) {\r\n          return;\r\n        }\r\n\r\n        const handleMissingStyleName = stats.opts && stats.opts.handleMissingStyleName || optionsDefaults.handleMissingStyleName;\r\n\r\n        if (t.isStringLiteral(styleNameAttribute.value)) {\r\n          resolveStringLiteral(\r\n            path,\r\n            filenameMap[filename].styleModuleImportMap,\r\n            styleNameAttribute,\r\n            {\r\n              handleMissingStyleName\r\n            }\r\n          );\r\n\r\n          return;\r\n        }\r\n\r\n        if (t.isJSXExpressionContainer(styleNameAttribute.value)) {\r\n          if (!filenameMap[filename].importedHelperIndentifier) {\r\n            setupFileForRuntimeResolution(path, filename);\r\n          }\r\n          replaceJsxExpressionContainer(\r\n            t,\r\n            path,\r\n            styleNameAttribute,\r\n            filenameMap[filename].importedHelperIndentifier,\r\n            filenameMap[filename].styleModuleImportMapIdentifier,\r\n            {\r\n              handleMissingStyleName\r\n            }\r\n          );\r\n        }\r\n      },\r\n      Program (path: *, stats: *): void {\r\n        if (!validate(stats.opts)) {\r\n          // eslint-disable-next-line no-console\r\n          console.error(validate.errors);\r\n\r\n          throw new Error('Invalid configuration');\r\n        }\r\n\r\n        const filename = stats.file.opts.filename;\r\n\r\n        filenameMap[filename] = {\r\n          styleModuleImportMap: {}\r\n        };\r\n      }\r\n    }\r\n  };\r\n};\r\n"]}